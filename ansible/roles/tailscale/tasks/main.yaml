---
- name: Check if Tailscale is installed
  ansible.builtin.stat:
    path: /usr/bin/tailscale
  register: tailscale_binary

- name: Add Tailscale GPG key
  ansible.builtin.shell: |
    URL="https://pkgs.tailscale.com/stable/ubuntu"
    curl -fsSL "${URL}/noble.noarmor.gpg" | \
      gpg --dearmor -o /usr/share/keyrings/tailscale-archive-keyring.gpg
  when: not tailscale_binary.stat.exists
  args:
    creates: /usr/share/keyrings/tailscale-archive-keyring.gpg

- name: Add Tailscale repository
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/tailscale.list
    content: |
      URL="https://pkgs.tailscale.com/stable/ubuntu"
      deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] ${URL} noble main
    mode: '0644'
  when: not tailscale_binary.stat.exists

- name: Install Tailscale package
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: true
  when: not tailscale_binary.stat.exists

- name: Enable tailscaled service
  ansible.builtin.systemd:
    name: tailscaled
    enabled: true
    state: started

name: CI

on:
  pull_request:
  push:
    branches:
    - master

permissions:
  contents: read

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"
    - name: Install pre-commit
      run: pip install pre-commit==4.5.1
    - name: Run pre-commit
      run: pre-commit run --all-files

  kubeconform:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
    - name: Install kubeconform
      run: |
        curl -sSL https://github.com/yannh/kubeconform/releases/download/v0.7.0/kubeconform-linux-amd64.tar.gz \
          | tar -xz
        sudo mv kubeconform /usr/local/bin/kubeconform
    - name: Validate manifests
      run: |
        find apps infrastructure bootstrap -name "*.yaml" ! -name "app.yaml" ! -name ".argocd-source-*.yaml" -print0 \
          | xargs -0 kubeconform -kubernetes-version 1.35.0 -strict -ignore-missing-schemas -summary

  docs-build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6
    - name: Detect docs changes
      id: changes
      uses: dorny/paths-filter@v3
      with:
        filters: |
          docs:
            - "docs/**"
            - ".github/workflows/ci.yaml"
    - name: Set up Bun
      if: steps.changes.outputs.docs == 'true'
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest
    - name: Install dependencies
      if: steps.changes.outputs.docs == 'true'
      run: bun install --frozen-lockfile
      working-directory: docs
    - name: Build docs
      if: steps.changes.outputs.docs == 'true'
      run: bun run build
      working-directory: docs

  docs-push:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}-docs
    steps:
    - name: Checkout
      uses: actions/checkout@v6
    - name: Detect docs changes
      id: changes
      uses: dorny/paths-filter@v3
      with:
        filters: |
          docs:
            - "docs/**"
            - ".github/workflows/ci.yaml"
    - name: Set up QEMU
      if: steps.changes.outputs.docs == 'true'
      uses: docker/setup-qemu-action@v3
    - name: Set up Docker Buildx
      if: steps.changes.outputs.docs == 'true'
      uses: docker/setup-buildx-action@v3
    - name: Log in to the Container registry
      if: steps.changes.outputs.docs == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Extract metadata
      if: steps.changes.outputs.docs == 'true'
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=latest
          type=sha,format=short
    - name: Build and push docs image
      if: steps.changes.outputs.docs == 'true'
      uses: docker/build-push-action@v6
      with:
        context: ./docs
        push: true
        platforms: linux/amd64,linux/arm64
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

apiVersion: v1
kind: ConfigMap
metadata:
  name: ntfy-alerts-app
  namespace: ntfy-alerts
data:
  app.py: |
    import json
    import os
    import sys
    import urllib.error
    import urllib.request
    from http.server import BaseHTTPRequestHandler, HTTPServer

    NTFY_URL = os.getenv("NTFY_URL", "http://ntfy.ntfy.svc.cluster.local")
    NTFY_TOPIC = os.getenv("NTFY_TOPIC", "alerts")
    TITLE_PREFIX = os.getenv("TITLE_PREFIX", "")
    PORT = int(os.getenv("PORT", "8080"))


    def build_message(payload):
        status = str(payload.get("status", "unknown")).upper()
        common_labels = payload.get("commonLabels") or {}
        common_annotations = payload.get("commonAnnotations") or {}

        alerts = payload.get("alerts") or []
        alert_count = len(alerts)

        def pick_label(key, default=""):
            value = common_labels.get(key)
            if value:
                return value
            for alert in alerts:
                value = (alert.get("labels") or {}).get(key)
                if value:
                    return value
            return default

        def pick_annotation(keys, default=""):
            for key in keys:
                value = common_annotations.get(key)
                if value:
                    return value
            for alert in alerts:
                annotations = alert.get("annotations") or {}
                for key in keys:
                    value = annotations.get(key)
                    if value:
                        return value
            return default

        alertname = pick_label("alertname", "Alert")
        severity = pick_label("severity", "unknown")
        summary = pick_annotation(["summary", "description"])

        if alert_count > 1:
            title = f"{TITLE_PREFIX}{status} {alert_count} alerts".strip()
        else:
            title = f"{TITLE_PREFIX}{status} {alertname} ({severity})".strip()

        lines = [f"severity={severity}", f"alerts={alert_count}"]
        if alert_count == 1:
            namespace = pick_label("namespace")
            pod = pick_label("pod")
            node = pick_label("node") or pick_label("instance")
            if namespace:
                lines.append(f"namespace={namespace}")
            if pod:
                lines.append(f"pod={pod}")
            if node:
                lines.append(f"node={node}")
            if summary:
                lines.append(summary)
        else:
            details = []
            for alert in alerts[:3]:
                labels = alert.get("labels") or {}
                annotations = alert.get("annotations") or {}
                name = labels.get("alertname", "Alert")
                namespace = labels.get("namespace")
                pod = labels.get("pod")
                node = labels.get("node") or labels.get("instance")
                note = annotations.get("summary") or annotations.get("description") or ""
                line = name
                if namespace and pod:
                    line = f"{line} {namespace}/{pod}"
                elif namespace:
                    line = f"{line} ns={namespace}"
                if node:
                    line = f"{line} node={node}"
                if note:
                    line = f"{line} - {note}"
                details.append(line)
            if details:
                lines.append("details:")
                lines.extend(details)
            if alert_count > len(details):
                lines.append(f"...and {alert_count - len(details)} more")

        message = "\n".join(lines)
        if len(message) > 3500:
            message = message[:3497] + "..."
        return title, message, severity


    def severity_priority(severity):
        severity = (severity or "").lower()
        if severity in {"critical", "page"}:
            return "5"
        if severity in {"warning", "warn"}:
            return "4"
        return "3"


    def send_ntfy(title, message, severity):
        url = f"{NTFY_URL.rstrip('/')}/{NTFY_TOPIC}"
        data = message.encode("utf-8")
        headers = {
            "Title": title,
            "Priority": severity_priority(severity),
            "Content-Type": "text/plain; charset=utf-8",
        }
        request = urllib.request.Request(url, data=data, headers=headers, method="POST")
        with urllib.request.urlopen(request, timeout=10) as response:
            response.read()


    class WebhookHandler(BaseHTTPRequestHandler):
        def _send(self, code, body):
            self.send_response(code)
            self.send_header("Content-Type", "text/plain; charset=utf-8")
            self.end_headers()
            self.wfile.write(body.encode("utf-8"))

        def do_GET(self):
            if self.path == "/healthz":
                self._send(200, "ok")
                return
            self._send(404, "not found")

        def do_POST(self):
            if self.path != "/webhook":
                self._send(404, "not found")
                return

            length = int(self.headers.get("Content-Length", "0"))
            if length <= 0:
                self._send(400, "empty payload")
                return

            payload = self.rfile.read(length)
            try:
                data = json.loads(payload.decode("utf-8"))
            except json.JSONDecodeError:
                self._send(400, "invalid json")
                return

            try:
                title, message, severity = build_message(data)
                send_ntfy(title, message, severity)
            except Exception as exc:
                print(str(exc), file=sys.stderr)
                self._send(500, "failed")
                return

            self._send(200, "sent")

        def log_message(self, format, *args):
            return


    def main():
        server = HTTPServer(("0.0.0.0", PORT), WebhookHandler)
        server.serve_forever()


    if __name__ == "__main__":
        main()
